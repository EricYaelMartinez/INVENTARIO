<?php
include 'conexion.php'; // Incluye el archivo de conexión

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    
    $action = $_POST['action'] ?? ''; // 'insert', 'update', o 'delete'

    // --- Lógica para MANEJO DE IMAGEN ---
    $imagen_url = $_POST['ImagenURL_actual'] ?? null; // URL actual si existe
    
    if (isset($_FILES['ImagenReferencia']) && $_FILES['ImagenReferencia']['error'] === UPLOAD_ERR_OK) {
        $upload_dir = 'uploads/';
        if (!is_dir($upload_dir)) {
            mkdir($upload_dir, 0777, true);
        }
        $file_tmp_name = $_FILES['ImagenReferencia']['tmp_name'];
        $file_name = uniqid() . '_' . basename($_FILES['ImagenReferencia']['name']); // Nombre único
        $upload_path = $upload_dir . $file_name;

        if (move_uploaded_file($file_tmp_name, $upload_path)) {
            $imagen_url = $upload_path; // Asigna la nueva URL
        } else {
            // Manejar error de subida
            die("Error al subir la imagen.");
        }
    }
    // -------------------------------------

    // 1. Lógica para AGREGAR (INSERT)
    if ($action === 'insert') {
        $nombre = $_POST['Nombre'];
        $descripcion = $_POST['Descripcion'];
        $precio_venta = $_POST['PrecioVenta'];
        $stock = $_POST['Stock'];
        $categoria_id = $_POST['CategoriaID'];

        $sql = "INSERT INTO Productos (Nombre, Descripcion, PrecioVenta, Stock, ImagenURL, CategoriaID) 
                VALUES (?, ?, ?, ?, ?, ?)";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$nombre, $descripcion, $precio_venta, $stock, $imagen_url, $categoria_id]);

        echo "Producto agregado exitosamente.";
    }

    // 2. Lógica para MODIFICAR (UPDATE)
    else if ($action === 'update') {
        $producto_id = $_POST['ProductoID'];
        $nombre = $_POST['Nombre'];
        $descripcion = $_POST['Descripcion'];
        $precio_venta = $_POST['PrecioVenta'];
        $stock = $_POST['Stock'];
        $categoria_id = $_POST['CategoriaID'];
        
        $sql = "UPDATE Productos SET 
                Nombre = ?, Descripcion = ?, PrecioVenta = ?, Stock = ?, 
                ImagenURL = ?, CategoriaID = ? 
                WHERE ProductoID = ?";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$nombre, $descripcion, $precio_venta, $stock, $imagen_url, $categoria_id, $producto_id]);

        echo "Producto modificado exitosamente.";
    }

    // 3. Lógica para ELIMINAR (DELETE)
    else if ($action === 'delete') {
        $producto_id = $_POST['ProductoID'];

        // Opcional: Eliminar el archivo de imagen del servidor si existe
        // Aquí podrías agregar lógica para obtener la ImagenURL y usar unlink($url)

        $sql = "DELETE FROM Productos WHERE ProductoID = ?";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$producto_id]);

        echo "Producto eliminado exitosamente.";
    }

    // Redireccionar al listado de productos
    header("Location: listado_productos.php"); 
    exit();

} else {
    // Si se accede sin POST, puede ser una vista para modificar
    if (isset($_GET['id'])) {
        include 'conexion.php';
        $producto_id = $_GET['id'];
        
        $sql = "SELECT * FROM Productos WHERE ProductoID = ?";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$producto_id]);
        $producto = $stmt->fetch();

        if (!$producto) {
            die("Producto no encontrado.");
        }
        
        // Incluye el formulario para precargar los datos del producto
        include 'formulario_productos.php'; 
    } else {
        // Incluye el formulario para agregar un producto nuevo
        include 'formulario_productos.php'; 
    }
}
?>